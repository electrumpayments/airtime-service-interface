---
title: "Advanced Topics"
menu:
  main:
    weight: 30
---

## Request ID Construction And Handling

Generation of UUIDs for voucher provision request messages is an important step in the request process. The voucherId field of a VoucherRequest is the single field guaranteed to always allow an entity to locate all messages pertaining to a voucher request (as well has subsequent related messages). It is therefore important that the voucherId value generated by a client is unique for that client. If you are developing a client implementation, please take note to generate IDs as random UUID's, as defined for a variant 4 UUID by [RFC 4122](https://tools.ietf.org/html/rfc4122). These request identifiers must uniquely identify a request within your own client implementation. If possible, the sender should check that the UUID produced for a message has not been previously generated. If the UUID has been used previously then the client should generate a new UUID. This process should be repeated as necessary until a unique UUID has been generated.

This specification acknowledges that since clients produce random UUIDs, there is a possibility that a client might repeat an ID for two independent messages of the same type if the client is unable to perform the above checks. Furthermore, independent clients may submit two distinct requests with the same UUIDs. Therefore, if you are developing a server implementation, take care to verify that a request to create a resource does not contain an ID that already exists in the system. All such requests must be declined with a status code of 400 and an [ErrorType](/specification/definitions/#errordetail) of DUPLICATE_RECORD.

Finally, if a sender receives an HTTP 400 response with an [ErrorType](/specification/definitions/#errordetail) of DUPLICATE_RECORD, it is suggested that the sender simply generate a new UUID for the request and resubmit the request with the new UUID.


## Request Matching

The manner in which messages created after an initial voucher provision request are associated with the original voucher provision request is dependent on the type of message.

### Reversal Matching

A reversal may be generated if no response is received from the receiver. Thus the sender of a voucher reversal message will have no knowledge of how to reference the original request (or possible voucher) within the receiver's system. However, the primary purpose of request UUIDs as described above is to ensure each distinct request can be uniquely identified. Therefore a reversal must contain the ID of the original request to be reversed. Since request IDs are generated by the sender, the sender of a reversal will always know the ID of the original request to be reversed. Thus voucher provisioning may be reversed by the receiver whether or not an original response was received by the downstream entity.

### Advice Matching

If the client received a voucher in response to the original request then the sender is aware of the voucher received. Thus the sender must include the advice in the subsequent advice message confirming or voiding the voucher. The server can then also directly locate the voucher to be voided. To this end the voucher's serial number field is intended to allow the server to use a value of its own choosing to identify the voucher within the server's system. The client must send the voucher serial number (and batch number if present) in the advice message in order to reduce the burden on the server of locating the voucher.

## Reversals vs Voids vs Refunds

Reversal and void messages are two distinct messages which both serve to undo the provisioning of a voucher so that it may not be redeemed. Thus these concepts may be easily confused and one should always be careful to distinguish between these two concepts in discussions and when implementing the Airtime Service Interface.

Reversal messages pertain specifically to voucher provision requests for which the client did not receive a final response or was not able to complete the processing of the response. Thus the client has direct knowledge of the voucher provision request to be reversed but not of the possible voucher which may have been provisioned. The client must include the original request in the reversal message.

Void messages are used specifically to void a voucher which the sender knows for certain has been provisioned. Thus a void will always refer to a specific voucher to be voided.

Refunds are beyond the scope of the Airtime Service Interface.


## Store-and-forward

To ensure that loss of transactional data is minimized, the Airtime Service Interface requires clients to store advice messages in persistent storage and queued until a final status type is received. A final response is one of either the _successful_ or _failed_ status types. If the airtime service is not responding, or responding with an _unknown_ status type, advice messages shall be queued and the message at the head of the queue repeated regularly until a final status type is received. For high throughput systems it shall be acceptable to send several messages in parallel. Client and server systems in high throughput environments should therefore be prepared to process advice and advice response messages in any order.

The above applies to the following operations:

* confirmation
* reversal
* void
