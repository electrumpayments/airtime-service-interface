---
title: "Advanced Topics"
menu:
  main:
    weight: 30
---

## Request ID Construction And Handling

Request messages are always the initial message in a voucher transaction with subsequent reversals, confirmations or voids referencing the original request. If a server receives a request message and is able to provision a voucher then subsequent confirmation or void messages may then refer to the voucher in question. However, a client may timeout while waiting for a response to a provision request and need to reverse the provision. In this instance the client has no reference from the server which may be used to identify the voucher within the server's system. Therefore the client will use the request identifier submitted in the original request to identify the voucher provision to be reversed.

If the server received the original request then the server can use the identifier of the original request to determine if a voucher was indeed provisioned and then reverse it. Therefore it is important that the request identifier uniquely identifies a single provision request. If you are developing a client implementation, please take note to generate IDs as random UUID's, as defined for a variant 4 UUID by [RFC 4122](https://tools.ietf.org/html/rfc4122). These request identifiers must uniquely identify a request within your own client implementation.

Conversely, if you are developing a server implementation, take care to verify that a request to create a resource does not contain an ID that already exists in the system associated with the client, and decline all such requests with a status code of 400 and an [ErrorType](/specification/definitions/#errordetail) of DUPLICATE_RECORD. It is unreasonable to expect that many client implementations are aware of the request identifiers generated by each other and thus will not generate identical identifiers. The server therefore has license to alter the request identifier associated with a request received from a client subject to the following conditions:

- All references to the request in responses to the client use the original request identifier
- The altered request identifier can be determined given the client's generated request identifier and knowledge of the sender of the original request.

Thus the onus is on the server implementation to ensure that if a reversal is received with a request identifier associated with more than one request, the server is able to correctly identify the original request sent from the client.


## Request Matching - Matching Reversals And Voids

The primary purpose of request IDs as described above is to ensure each distinct request can be uniquely identified. Thus a reversal must contain the ID of the original request to be reversed. Since request IDs are generated by the client, the sender of a reversal will always know the ID of the original request to be reversed. Thus voucher provisioning may be reversed even if no response was received by the downstream entity.

If the client received a response to the original request then the void will also contain the voucher returned in original request response. Therefore the void request directly references the voucher to be voided. The server can then directly locate the voucher to be voided. The voucher's serial number is intended to allow the server to use a value of its own choosing to identify the voucher within the server's system. The client must send the voucher serial number (and batch number if present) in the void message in order to reduce the burden on the server of locating the voucher.

## Reversals vs Voids vs Refunds

Reversal and void messages are two distinct messages which both serve to undo the provisioning of a voucher so that it may not be redeemed. Thus these concepts may be easily confused and one should always be careful to distinguish between these two concepts in discussions and when implementing the Airtime Service Interface.

Reversal messages pertain specifically to voucher provision requests for which the client did not receive a final response or was not able to complete the processing of the response. Thus the client has direct knowledge of the voucher provision request to be reversed but not of the possible voucher which may have been provisioned. The client must include the original request in the reversal message.

Void messages are used specifically to void a voucher which the sender knows for certain has been provisioned. Thus a void will always refer to a specific voucher to be voided.

Refunds are beyond the scope of the Airtime Service Interface.


## Store-and-forward

To ensure that loss of transactional data is minimized, the Airtime Service Interface requires clients to store advice messages in persistent storage and queued until a final status type is received. A final response is one of either the _successful_ or _failed_ status types. If the airtime service is not responding, or responding with an _unknown_ status type, advice messages shall be queued and the message at the head of the queue repeated regularly until a final status type is received. For high throughput systems it shall be acceptable to send several messages in parallel. Client and server systems in high throughput environments should therefore be prepared to process advice and advice response messages in any order.

The above applies to the following operations:

* confirmation
* reversal
* void
